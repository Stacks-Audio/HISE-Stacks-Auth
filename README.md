# STACKS Auth - HISE

This repository reflects the latest official means of implementing Stacks Authentication into audio plugins built with HISE. It is designed to be lightweight and generic so that the plugin developer can implement it into their project regardless of current structure.

## Getting Started

1. Copy the `StacksAuth.js` file in this repository into your HISE project's `Scripts` folder.

2. Open the file in your preferred editor. Change the `stacksProductId` variable on line 12 to the id of your product on Stacks. If you're not sure what your product id is, navigate to the product on Stacks. The product id is the last path segment (e.g., in the url `https://stacks.audio/products/string-central-ejyn`, the id is `string-central-ejyn`)

3. Change the `publicKey` variable on line 13 to your public RSA key. You may use an existing key if you have one, or you can generate a new RSA key pair for use in Stacks. Note that this key must be in the modulus exponent format (it should look something like: `010001,00b2e5919a...`). For steps on converting your key to this format, see the 'RSA Keys' section below.

## Implementation Guide

Once you've updated the values in `StacksAuth.js`, you can import the `StacksAuth` namespace wherever you prefer using the line `include("StacksAuth.js");`. There are two utility functions provided:

1. `StacksAuth.authenticate()`

   - Returns a boolean value reflecting whether the user can access the product.

2. `StacksAuth.getLastErrorMessage()`
   - Returns a string value detailing the reason for failure in the last call to `authenticate()`.

A basic example is provided in `Example.js`, conditionally rendering one of two panels and updating an error label in the case of failure in the `onInit()` callback of the Interface. There are no restrictions on where or how you choose to implement.

## Testing

1. From your brand's page on Stacks, select or create a new product.

2. In the 'versions' tab, create a new version for testing. You can delete it later. Check the 'Use Stacks Auth' checkbox, and select HISE v2 from the version dropdown.

3. In the 'Files' tab of the new version modal, click the green 'Auth File' button. Click on the newly created file to expand it. You can add your other product files too, if you prefer to do a full test.

4. Set the Windows Path to `~\Music\StacksAppFiles\product-id.authfile` and the MacOS path to `~/Music/StacksAppFiles/product-id.authfile` (be sure to replace with your product id!)

5. Add the version.

6. Before exiting the versions tab, click the 'Edit RSA Key' button and paste in your RSA private key (including the -----BEGIN RSA PRIVATE KEY----- and -----END RSA PRIVATE KEY----- parts). If you do not have an RSA key yet, please refer to the 'RSA Keys' section below. This value is stored securely in Stacks' servers. It can be updated at any time but cannot be read again after being set. We recommend retaining your own copy in a secure location only you and trusted brand members can access.

7. In the Stacks App, navigate to your product. As a manager of the product, you should see an option to add to your stack if you haven't already.

8. Download from the My Stack page.

9. Open your plugin. You should now pass the authentication check. Sometimes it may take up to a minute before the auth file is written. Stacks will continue to update it on a daily basis in the background, regardless of whether the app is open or not.

## RSA Keys

Stacks Auth relies on an RSA public/private key encryption system to protect HISE plugins. There are multiple formats for RSA keys. The format Stacks expects is different than the one used in HISE. Because of this, the keys generated by HISE's built in `Generate RSA key pair` functionality cannot be used out of the box and must be converted. For minimum difficulty, we recommend the following steps for generating your RSA keys.

Note that these steps utilise the `openssl` library which comes built in on MacOS & Linux machines. On Windows, you can use Git Bash (which also comes packaged with `openssl`), or alternatively download openssl on its own (search for 'openssl cli windows').

If you're having difficulties generating your RSA keys, reach out to a Stacks team member and we will get back to you shortly with the keys you need.

# Generating a key pair

1. Open your preferred terminal.

2. Navigate to where you want to create your key values. We recommend somewhere easy to access, like your Desktop. You can move these later.

   - MacOS/Linux: `cd ~/Desktop`
   - Windows: `cd %USERPROFILE%\Desktop`

3. Run `openssl genrsa -out private_key.pem 1024` to generate a 1024 bit private RSA key. You can use however many bits you want, but it is highly recommended that you use at least 1024 bits for security reasons.

4. Run `openssl rsa -in private_key.pem -pubout -out public_key.pem` to generate your public key.

5. Open `private_key.pem` in TextEdit/Notepad. The text contents of this file are what should be pasted into Stacks when you click 'Edit RSA key'.

6. The `private_key.pem` value is not in the format needed for HISE (modulus exponent format). To get the value needed:

   - Run `openssl rsa -pubin -in public_key.pem -text -noout`.
   - Copy the modulus part of the command output. Remove any whitespace, new lines, and colons. It's recommended to do this in a text editor with a search and replace.
   - Copy the 'exponent' part of the command output inside of the parentheses, but only the digits following `0x`. If the output was: `Exponent: 65537 (0x10001)`, you should copy `10001`. Lastly, add a 0 to the beginning (e.g. `010001`).
   - Combine the exponent with the modulus, separated by a comma. The result should look something like: `010001,00b2e5919a...`.

7. The `publicKey` variable in the `StacksAuth.js` script should be set to the value obtained in step 6.

8. We recommend renaming the `private_key.pem` file to reflect your product, and storing it somewhere secure. You do not need to save the `public_key.pem` file if you don't want to. It can be derived from the private key at any time using the command in step 4.
